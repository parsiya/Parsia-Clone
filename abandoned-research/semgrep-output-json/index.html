<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>Semgrep Output Processing in Go</title>
<link rel=stylesheet href=/css/hugo-octopress.css><link rel=stylesheet href=https://parsiya.io//clone.css><link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://parsiya.io/favicon.png rel=icon><meta name=description content><meta name=keywords content="[Parsia Hakimian Parsiya infosec information security]"><meta name=author content="Parsia-Clone"><meta name=generator content="Hugo 0.123.4"><meta name=twitter:card content="summary"><meta name=twitter:title content="Semgrep Output Processing in Go"><meta name=twitter:description content="This is something I wrote in November 2022 when I was trying to convert the JSON Schema for Semgrep's output to Go structs. Things have changed since then and I think gojsonschema works correctly now.
Draft 2020-12 Located at https://github.com/returntocorp/semgrep-interfaces/blob/main/semgrep_output_v0.jsonschema.
This draft is too advanced so most libraries cannot parse it.
atombender/go-jsonschema CAN get something IF we use the master branch (and not the latest tagged version).
The lastest tagged version gets this error:"><meta name=twitter:domain content="parsiya.io"><meta name=twitter:creator content="@CryptoGangsta"></head><body><header role=banner><hgroup><h1><a href=https://parsiya.io/>Parsia-Clone</a></h1><h2>'Documentation is a love letter that you write to your future self.' - Damian Conway</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://github.com/parsiya/Parsia-Clone>» Parsia-Clone on Github</option><option value=https://parsiya.net/categories/clone/>» How did I make this?</option><option value=https://parsiya.net>» My Main Website</option></select></fieldset><ul class=main-navigation><li><a href=https://github.com/parsiya/Parsia-Clone title="Parsia-Clone on Github" target=_blank rel="noopener noreferrer">Parsia-Clone on Github</a></li><li><a href=https://parsiya.net/categories/clone/ title="How did I make this?" target=_blank rel="noopener noreferrer">How did I make this?</a></li><li><a href=https://parsiya.net title="My Main Website" target=_blank rel="noopener noreferrer">My Main Website</a></li></ul><ul class=subscription></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://parsiya.io/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>3 minute read
- <a class=label href=https://parsiya.io/categories/abandoned-research/>Abandoned Research</a></p><h1 class=entry-title>Semgrep Output Processing in Go</h1><a href=https://github.com/parsiya/Parsia-Clone/tree/main/abandoned-research/semgrep-output-json.md target=_blank>Github Link</a></header><div class=entry-content><nav id=TableOfContents><ul><li><a href=#draft-2020-12>Draft 2020-12</a></li><li><a href=#draft-07>Draft-07</a></li></ul></nav><p>This is something I wrote in November 2022 when I was trying to convert the
JSON Schema for Semgrep's output to Go structs. Things have changed since then
and I think gojsonschema works correctly now.</p><h1 id=draft-2020-12>Draft 2020-12
<a class=header-link href=#draft-2020-12><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>Located at <a href=https://github.com/returntocorp/semgrep-interfaces/blob/main/semgrep_output_v0.jsonschema target=_blank rel="noreferrer noopener">https://github.com/returntocorp/semgrep-interfaces/blob/main/semgrep_output_v0.jsonschema</a>.</p><p>This draft is too advanced so most libraries cannot parse it.</p><p><a href=https://github.com/atombender/go-jsonschema target=_blank rel="noreferrer noopener">atombender/go-jsonschema</a> CAN get something IF we use the master branch (and not the latest tagged version).</p><p>The lastest tagged version gets this error:</p><pre tabindex=0><code>$ go install github.com/atombender/go-jsonschema/cmd/gojsonschema@mlatest

$ gojsonschema -p main -o semgrep-result.go --verbose semgrep_output_v0.jsonschema
gojsonschema: Loading semgrep_output_v0.jsonschema
gojsonschema: Failed: error parsing from file semgrep_output_v0.jsonschema: json: cannot unmarshal bool into Go struct field Type.definitions.oneOf.items of type schemas.Type
</code></pre><p>But the latest commit from master does more:</p><pre tabindex=0><code>$ go install github.com/atombender/go-jsonschema/cmd/gojsonschema@master

$ gojsonschema -p main -o semgrep_result.go --verbose semgrep_output_v0.jsonschema
gojsonschema: Loading semgrep_output_v0.jsonschema
gojsonschema: Warning: Property has multiple types; will be represented as interface{} with no validation
gojsonschema: Warning: Property has multiple types; will be represented as interface{} with no validation
gojsonschema: Warning: Property has multiple types; will be represented as interface{} with no validation
gojsonschema: Warning: Multiple types map to the name &#34;CliMatchExtra&#34;; declaring duplicate as &#34;CliMatchExtra_1&#34; instead
gojsonschema: Warning: Cycle detected; must wrap type MatchingExplanation in pointer
gojsonschema: Warning: Multiple types map to the name &#34;CoreMatchExtra&#34;; declaring duplicate as &#34;CoreMatchExtra_1&#34; instead
gojsonschema: Writing semgrep_result.go
</code></pre><p>See <code>go-jsonschema_semgrep_result.go</code> file below. See how problematic stuff like <code>CoreErrorKind</code> are handwaved as <code>interface{}</code> (line 229).</p><p>Everything else returns a similar error. Apparently, it's because they might not support the draft 2020-12 versions.</p><p>For example, <a href=https://github.com/a-h/generate target=_blank rel="noreferrer noopener">a-h/generate</a>. Getting this to install is tricky, because the instructions use <code>go get</code> which has been deprecated for quite some time.</p><pre tabindex=0><code>$ git clone https://github.com/a-h/generate --depth=1
$ cd generate
# the mod name is not important, you can use whatever you want
$ go mod init github.com/a-h/generate
$ go mod tidy
$ go get github.com/a-h/generate
$ make
</code></pre><p>Now, we have the <code>schema-generate</code> executable here.</p><pre tabindex=0><code>$ ./schema-generate -p main -o ../generate.go ../semgrep_output_v0.jsonschema
the JSON type &#39;bool&#39; cannot be converted into the Go &#39;Schema&#39; type on struct &#39;Schema&#39;, field &#39;Definitions.OneOf.Items&#39;. See input file ../semgrep_output_v0.jsonschema line 128, character 26
</code></pre><p>Seems like our issue is about implementing <code>OneOf.Items</code>. One of the pull requests mention fixing it and it didn't work either.</p><pre tabindex=0><code>$ git clone https://github.com/lustefaniak/generate/ generate-oneoff --depth=1 -b optional-one-off
$ cd generate-oneoff
# the mod name is not important, you can use whatever you want
$ go mod init github.com/lustefaniak/generate
$ go mod tidy
$ make
</code></pre><p><a href=https://git.sr.ht/~emersion/go-jsonschema target=_blank rel="noreferrer noopener">https://git.sr.ht/~emersion/go-jsonschema</a> supposedly supports Draft 2020-12 but just generates this useless struct (for both versions):</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#719e07>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#268bd2>type</span> Root <span style=color:#268bd2>map</span>[<span style=color:#dc322f>string</span>]<span style=color:#268bd2>interface</span>{}
</span></span></code></pre></div><h1 id=draft-07>Draft-07
<a class=header-link href=#draft-07><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h1><p>Martin kindly provided a version of the JSONSchema in the Draft-07 version:
<a href=https://github.com/returntocorp/semgrep-interfaces/blob/mj-jsonschema-2019/semgrep_output_v0.jsonschema-draft-07 target=_blank rel="noreferrer noopener">https://github.com/returntocorp/semgrep-interfaces/blob/mj-jsonschema-2019/semgrep_output_v0.jsonschema-draft-07</a></p><p>I could get it to work was in <a href=https://app.quicktype.io/ target=_blank rel="noreferrer noopener">https://app.quicktype.io/</a>. It omitted some structs.</p><p>You can see the result in the <code>semgrep_results_quicktype-io.go</code> file below.</p><p>Everything else still had issues (even the master version of <code>gojsonschema</code> that worked with the 2020-12 version above.</p><pre tabindex=0><code>$ ./schema-generate -p main -o ../generate_3.go ../semgrep_output_v0.jsonschema-draft-07
the JSON type &#39;array&#39; cannot be converted into the Go &#39;Schema&#39; type on struct &#39;Schema&#39;, field &#39;Definitions.OneOf.Items&#39;. See input file ../semgrep_output_v0.jsonschema-draft-07 line 130, character 1
</code></pre><p>Which is:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>    <span style=color:#2aa198>&#34;core_error_kind&#34;</span>: {
</span></span><span style=display:flex><span>      <span style=color:#268bd2>&#34;oneOf&#34;</span>: [
</span></span><span style=display:flex><span>        { <span style=color:#268bd2>&#34;const&#34;</span>: <span style=color:#2aa198>&#34;Lexical error&#34;</span> },
</span></span><span style=display:flex><span>        { <span style=color:#268bd2>&#34;const&#34;</span>: <span style=color:#2aa198>&#34;Syntax error&#34;</span> },
</span></span><span style=display:flex><span>        { <span style=color:#268bd2>&#34;const&#34;</span>: <span style=color:#2aa198>&#34;Other syntax error&#34;</span> },
</span></span><span style=display:flex><span>        { <span style=color:#268bd2>&#34;const&#34;</span>: <span style=color:#2aa198>&#34;AST builder error&#34;</span> },
</span></span><span style=display:flex><span>        { <span style=color:#268bd2>&#34;const&#34;</span>: <span style=color:#2aa198>&#34;Rule parse error&#34;</span> },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#268bd2>&#34;type&#34;</span>: <span style=color:#2aa198>&#34;array&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#268bd2>&#34;minItems&#34;</span>: <span style=color:#2aa198>2</span>,
</span></span><span style=display:flex><span>          <span style=color:#268bd2>&#34;additionalItems&#34;</span>: <span style=color:#cb4b16>false</span>,
</span></span><span style=display:flex><span>          <span style=color:#268bd2>&#34;items&#34;</span>: [ <span style=color:#586e75>// &lt;--- HERE
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>            { <span style=color:#268bd2>&#34;const&#34;</span>: <span style=color:#2aa198>&#34;Pattern parse error&#34;</span> },
</span></span><span style=display:flex><span>            { <span style=color:#268bd2>&#34;type&#34;</span>: <span style=color:#2aa198>&#34;array&#34;</span>, <span style=color:#268bd2>&#34;items&#34;</span>: { <span style=color:#268bd2>&#34;type&#34;</span>: <span style=color:#2aa198>&#34;string&#34;</span> } }
</span></span><span style=display:flex><span>          ]
</span></span></code></pre></div><p>Anyways, this is where I rage quit. I think I have enough structs to do what I want because I don't care about the errors at this point.</p></div><footer><p class=meta><span class=categories>Tags:
<a class=category href=https://parsiya.io/tags/semgrep>semgrep</a></span></p></footer></article></div><aside class="sidebar thirds"><section class="first odd"><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#draft-2020-12>Draft 2020-12</a></li><li><a href=#draft-07>Draft-07</a></li></ul></nav></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2024 Parsia-Clone - <a href=https://parsiya.io/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>