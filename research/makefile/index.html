<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=/css/fonts.css rel=stylesheet type=text/css><title>Makefile Notes</title>
<link rel=stylesheet href=/css/hugo-octopress.css><link rel=stylesheet href=https://parsiya.io//clone.css><link rel=stylesheet href=/css/fork-awesome.min.css><link href=https://parsiya.io/favicon.png rel=icon><meta name=description content><meta name=keywords content="[Parsia Hakimian Parsiya infosec information security]"><meta name=author content="Parsia-Clone"><meta name=generator content="Hugo 0.123.8"><meta name=twitter:card content="summary"><meta name=twitter:title content="Makefile Notes"><meta name=twitter:description content="Most of this is about GNU Make but should work with others.
If you want to find someone who likes to use both tabs and spaces as different separators in a text file, talk to the guy who invented Makefiles!
Me A makefile has a bunch of rules. Each rule has a target, some prerequisites (e.g., files) and a recipe. A recipe is a series of commands.
target: prereqs [tab] command1 command2 command3 The recipe should start with a tab."><meta name=twitter:domain content="parsiya.io"><meta name=twitter:creator content="@CryptoGangsta"></head><body><header role=banner><hgroup><h1><a href=https://parsiya.io/>Parsia-Clone</a></h1><h2>'Documentation is a love letter that you write to your future self.' - Damian Conway</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option><option value=https://github.com/parsiya/Parsia-Clone>» Parsia-Clone on Github</option><option value=https://parsiya.net/categories/clone/>» How did I make this?</option><option value=https://parsiya.net>» My Main Website</option></select></fieldset><ul class=main-navigation><li><a href=https://github.com/parsiya/Parsia-Clone title="Parsia-Clone on Github" target=_blank rel="noopener noreferrer">Parsia-Clone on Github</a></li><li><a href=https://parsiya.net/categories/clone/ title="How did I make this?" target=_blank rel="noopener noreferrer">How did I make this?</a></li><li><a href=https://parsiya.net title="My Main Website" target=_blank rel="noopener noreferrer">My Main Website</a></li></ul><ul class=subscription></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:https://parsiya.io/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Nov 30, 2022 -
4 minute read
- <a class=label href=https://parsiya.io/categories/random/>Random</a></p><h1 class=entry-title>Makefile Notes</h1><a href=https://github.com/parsiya/Parsia-Clone/tree/main/research/makefile/index.markdown target=_blank>Github Link</a></header><div class=entry-content><nav id=TableOfContents><ul><li><ul><li><a href=#use-recipeprefix>Use RECIPEPREFIX</a></li><li><a href=#phony>PHONY</a></li><li><a href=#conditionals>Conditionals</a></li><li><a href=#detect-if-command-exists>Detect if Command Exists</a></li><li><a href=#parallel-tasks>Parallel Tasks</a></li><li><a href=#run-multiple-targets>Run Multiple Targets</a></li><li><a href=#the-help-target>The Help Target</a></li></ul></li></ul></nav><p>Most of this is about <a href=https://www.gnu.org/software/make/ target=_blank rel="noreferrer noopener">GNU Make</a> but should work with others.</p><blockquote><p>If you want to find someone who likes to use both tabs and spaces as different
separators in a text file, talk to the guy who invented Makefiles!</p><ul><li>Me</li></ul></blockquote><p>A makefile has a bunch of rules. Each rule has a target, some prerequisites
(e.g., files) and a recipe. A recipe is a series of commands.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#268bd2>target</span><span style=color:#719e07>:</span> prereqs
</span></span><span style=display:flex><span>[tab]   command1
</span></span><span style=display:flex><span>        command2
</span></span><span style=display:flex><span>        command3
</span></span></code></pre></div><p>The recipe should start with a <code>tab</code>. But you also need to indent some other
things (e.g., conditionals) with space. This will be a mess.</p><h2 id=use-recipeprefix>Use RECIPEPREFIX
<a class=header-link href=#use-recipeprefix><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>To make your life easier, add this to the beginning of your makefile to replace
tab with another character.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#268bd2>.RECIPEPREFIX</span> <span style=color:#719e07>:=</span> &gt; <span style=color:#586e75># use `&gt;` instead of `\t`</span>
</span></span></code></pre></div><p><strong>Note:</strong> Macs come with GNU Make version 3.81 from 2006 that does not support
this. Either replace <code>^> </code>with <code>\t</code> after debugging and figuring out what it
does or just not support Macs :).</p><p>Now, your file looks like this:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#268bd2>target</span><span style=color:#719e07>:</span> prereqs
</span></span><span style=display:flex><span>&gt; command1
</span></span><span style=display:flex><span>&gt; command2
</span></span><span style=display:flex><span>&gt; command3
</span></span></code></pre></div><h2 id=phony>PHONY
<a class=header-link href=#phony><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>You can run each target with <code>make target</code>. However, if <code>target</code> also exists as
a file in the target directory, it will interfere. See <a href=https://www.gnu.org/software/make/manual/html_node/Phony-Targets.html target=_blank rel="noreferrer noopener">Phony Targets</a>.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#268bd2>.PHONY</span><span style=color:#719e07>:</span> target
</span></span><span style=display:flex><span><span style=color:#268bd2>target</span><span style=color:#719e07>:</span> prereqs
</span></span><span style=display:flex><span>&gt; command1
</span></span><span style=display:flex><span>&gt; command2
</span></span><span style=display:flex><span>&gt; command3
</span></span></code></pre></div><h2 id=conditionals>Conditionals
<a class=header-link href=#conditionals><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>Conditionals are different from programming languages. They do not necessarily
control the program flow but they hide/unhide instructions. Think of them as
<code>IFDEF</code>s in C. Let's use an example.</p><h2 id=detect-if-command-exists>Detect if Command Exists
<a class=header-link href=#detect-if-command-exists><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>I have tested this on Linux. It's supposedly POSIX compliant but I don't know if
it works on other OS yet. For example, if we want to check Python3 exists.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#268bd2>target</span><span style=color:#719e07>:</span>
</span></span><span style=display:flex><span><span style=color:#586e75># check if python3 exists
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>ifeq (<span style=color:#719e07>$(</span><span style=color:#268bd2>shell</span> <span style=color:#268bd2>command</span> -<span style=color:#268bd2>v</span> <span style=color:#268bd2>python</span>3 2&gt; /<span style=color:#268bd2>dev</span>/<span style=color:#268bd2>null</span><span style=color:#719e07>)</span>, )
</span></span><span style=display:flex><span>&gt; <span style=color:#719e07>$(</span><span style=color:#268bd2>error</span> <span style=color:#268bd2>python</span>3 <span style=color:#268bd2>not</span> <span style=color:#268bd2>installed</span><span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>endif
</span></span></code></pre></div><p><code>error</code> will terminate the makefile with an error.</p><p>Let's say you want to check if Semgrep exists and if not, install it.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#268bd2>target</span><span style=color:#719e07>:</span>
</span></span><span style=display:flex><span><span style=color:#586e75># install Semgrep if it&#39;s not installed
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>ifeq (<span style=color:#719e07>$(</span><span style=color:#268bd2>shell</span> <span style=color:#268bd2>command</span> -<span style=color:#268bd2>v</span> <span style=color:#268bd2>semgrep</span> 2&gt; /<span style=color:#268bd2>dev</span>/<span style=color:#268bd2>null</span><span style=color:#719e07>)</span>, )
</span></span><span style=display:flex><span>&gt; python3 -m pip install semgrep
</span></span><span style=display:flex><span>&gt; <span style=color:#719e07>$(</span><span style=color:#268bd2>info</span> <span style=color:#268bd2>you</span> <span style=color:#268bd2>might</span> <span style=color:#268bd2>have</span> <span style=color:#268bd2>to</span> <span style=color:#268bd2>add</span> ~/.<span style=color:#268bd2>local</span>/<span style=color:#268bd2>bin</span> <span style=color:#268bd2>to</span> <span style=color:#268bd2>PATH</span><span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>endif
</span></span></code></pre></div><p><code>info</code> prints some information.</p><h2 id=parallel-tasks>Parallel Tasks
<a class=header-link href=#parallel-tasks><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>You can parallelize the commands in the recipe instead of sequentially running
them. This can be done with <code>-j</code> (infinite) or <code>-j number-of-parallel-jobs</code>.</p><p>This is useful when each command is different. For example, building Go binaries
for different platforms. Note the use of the variable <code>BINARY_NAME</code>.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#268bd2>BINARY_NAME</span> <span style=color:#719e07>:=</span> myapp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#268bd2>.PHONY</span><span style=color:#719e07>:</span> build-all
</span></span><span style=display:flex><span><span style=color:#268bd2>build-all</span><span style=color:#719e07>:</span>
</span></span><span style=display:flex><span>&gt; <span style=color:#268bd2>GOARCH</span><span style=color:#719e07>=</span>arm64 <span style=color:#268bd2>GOOS</span><span style=color:#719e07>=</span>darwin go build -o <span style=color:#2aa198>${</span><span style=color:#268bd2>BINARY_NAME</span><span style=color:#2aa198>}</span>-darwin-arm64 -ldflags <span style=color:#2aa198>&#34;-w -s&#34;</span> main.go
</span></span><span style=display:flex><span>&gt; <span style=color:#268bd2>GOARCH</span><span style=color:#719e07>=</span>amd64 <span style=color:#268bd2>GOOS</span><span style=color:#719e07>=</span>darwin go build -o <span style=color:#2aa198>${</span><span style=color:#268bd2>BINARY_NAME</span><span style=color:#2aa198>}</span>-darwin-amd64 -ldflags <span style=color:#2aa198>&#34;-w -s&#34;</span> main.go
</span></span><span style=display:flex><span>&gt; <span style=color:#268bd2>GOARCH</span><span style=color:#719e07>=</span>arm64 <span style=color:#268bd2>GOOS</span><span style=color:#719e07>=</span>linux  go build -o <span style=color:#2aa198>${</span><span style=color:#268bd2>BINARY_NAME</span><span style=color:#2aa198>}</span>-linux-arm64  -ldflags <span style=color:#2aa198>&#34;-w -s&#34;</span> main.go
</span></span><span style=display:flex><span>&gt; <span style=color:#268bd2>GOARCH</span><span style=color:#719e07>=</span>amd64 <span style=color:#268bd2>GOOS</span><span style=color:#719e07>=</span>linux  go build -o <span style=color:#2aa198>${</span><span style=color:#268bd2>BINARY_NAME</span><span style=color:#2aa198>}</span>-linux-amd64  -ldflags <span style=color:#2aa198>&#34;-w -s&#34;</span> main.go
</span></span></code></pre></div><h2 id=run-multiple-targets>Run Multiple Targets
<a class=header-link href=#run-multiple-targets><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>You can have targets that run other ones. A popular target is <code>all</code>.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#268bd2>.PHONY</span><span style=color:#719e07>:</span> all
</span></span><span style=display:flex><span><span style=color:#268bd2>all</span><span style=color:#719e07>:</span> clean build deploy
</span></span></code></pre></div><p>This is an alternate way of writing a recipe. This is the same as below:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#268bd2>.PHONY</span><span style=color:#719e07>:</span> all
</span></span><span style=display:flex><span><span style=color:#268bd2>all</span><span style=color:#719e07>:</span>
</span></span><span style=display:flex><span>&gt; clean
</span></span><span style=display:flex><span>&gt; build
</span></span><span style=display:flex><span>&gt; deploy
</span></span></code></pre></div><p>Now we can run <code>make all</code> to run all these targets.</p><h2 id=the-help-target>The Help Target
<a class=header-link href=#the-help-target><svg class="fill-current o-60 hover-accent-color-light" height="22" viewBox="0 0 24 24" width="22" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76.0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71.0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71.0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76.0 5-2.24 5-5s-2.24-5-5-5z"/></svg></a></h2><p>If no argument is provided, make will run the first target. It's a good idea for
the first target to be the help/usage. We can print something manually:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#268bd2>.PHONY</span><span style=color:#719e07>:</span> help
</span></span><span style=display:flex><span><span style=color:#268bd2>help</span><span style=color:#719e07>:</span>
</span></span><span style=display:flex><span>&gt; <span style=color:#719e07>$(</span><span style=color:#268bd2>info</span> <span style=color:#268bd2>Usage</span><span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>&gt; <span style=color:#719e07>$(</span><span style=color:#268bd2>info</span> <span style=color:#268bd2>make</span> <span style=color:#268bd2>help</span>     <span style=color:#268bd2>print</span> <span style=color:#268bd2>help</span><span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>&gt; <span style=color:#719e07>$(</span><span style=color:#268bd2>info</span> <span style=color:#268bd2>make</span> <span style=color:#268bd2>all</span>      <span style=color:#268bd2>clean</span>, <span style=color:#268bd2>test</span> <span style=color:#268bd2>and</span> <span style=color:#268bd2>build</span><span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>&gt; <span style=color:#719e07>$(</span><span style=color:#268bd2>info</span> <span style=color:#268bd2>make</span> <span style=color:#268bd2>install</span>  <span style=color:#268bd2>install</span> <span style=color:#268bd2>dependencies</span><span style=color:#719e07>)</span>
</span></span></code></pre></div><p>We can also do it automatically. I forgot where I copied the code from but there
are multiple versions all over the internet.</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#268bd2>.PHONY</span><span style=color:#719e07>:</span> help
</span></span><span style=display:flex><span><span style=color:#268bd2>help</span><span style=color:#719e07>:</span>   <span style=color:#586e75>## print help
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>&gt; @sed -ne <span style=color:#2aa198>&#39;/@sed/!s/## //p&#39;</span> <span style=color:#719e07>$(</span><span style=color:#268bd2>MAKEFILE_LIST</span><span style=color:#719e07>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#268bd2>.PHONY</span><span style=color:#719e07>:</span> all
</span></span><span style=display:flex><span><span style=color:#268bd2>all</span><span style=color:#719e07>:</span>    <span style=color:#586e75>## clean, deploy, and build
</span></span></span><span style=display:flex><span><span style=color:#586e75></span>&gt; clean
</span></span><span style=display:flex><span>&gt; build
</span></span><span style=display:flex><span>&gt; deploy
</span></span></code></pre></div><p>If we run <code>make help</code> or <code>make</code> (help is the first target) we will see:</p><pre tabindex=0><code>help:   ## print help
all:    ## clean, deploy, and build
</code></pre><p>This is an issue if we have prerequisites. One of the other similar commands
might fix this but I did not investigate. Note, we have to manually fix the
whitespace between the target and the comment.</p></div><footer><p class=meta><span class=categories>Tags:
<a class=category href=https://parsiya.io/tags/makefile>Makefile</a></span></p></footer></article></div><aside class="sidebar thirds"><section class="first odd"><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><ul><li><a href=#use-recipeprefix>Use RECIPEPREFIX</a></li><li><a href=#phony>PHONY</a></li><li><a href=#conditionals>Conditionals</a></li><li><a href=#detect-if-command-exists>Detect if Command Exists</a></li><li><a href=#parallel-tasks>Parallel Tasks</a></li><li><a href=#run-multiple-targets>Run Multiple Targets</a></li><li><a href=#the-help-target>The Help Target</a></li></ul></li></ul></nav></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2024 Parsia-Clone - <a href=https://parsiya.io/license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>